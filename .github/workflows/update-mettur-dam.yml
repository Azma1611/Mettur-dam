name: Mettur Dam Daily Update (Real Data)

on:
  schedule:
    - cron: '0 6 * * *'  # runs every day at 6 AM
  workflow_dispatch:

jobs:
  update-dam-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch Mettur Dam real data
        run: |
          DATE=$(date '+%Y-%m-%d')

          # Download TN Agriculture reservoir page
          PAGE=$(curl -s "https://www.tnagriculture.in/ARS/home/reservoir")

          # Extract the METTUR row
          ROW=$(echo "$PAGE" | grep -i "METTUR")

          # Extract numbers (adjust column numbers if needed)
          LEVEL=$(echo "$ROW" | awk '{print $4}')
          STORAGE=$(echo "$ROW" | awk '{print $5}')
          INFLOW=$(echo "$ROW" | awk '{print $6}')
          OUTFLOW=$(echo "$ROW" | awk '{print $7}')

          # Fallback if empty
          LEVEL=${LEVEL:-0}
          STORAGE=${STORAGE:-0}
          INFLOW=${INFLOW:-0}
          OUTFLOW=${OUTFLOW:-0}

          # Calculate change
          if [ -f daily.json ]; then
            OLD_LEVEL=$(jq '.water_level_ft' daily.json)
          else
            OLD_LEVEL=0
          fi

          CHANGE=$(awk "BEGIN {printf \"%.2f\", $LEVEL - $OLD_LEVEL}")

          TREND="decreased"
          if (( $(echo "$CHANGE > 0" | bc -l) )); then
            TREND="increased"
          fi

          # Create JSON
          cat <<EOF > daily.json
          {
            "dam": "Mettur Dam (Stanley Reservoir)",
            "date": "$DATE",
            "water_level_ft": $LEVEL,
            "storage_mcft": $STORAGE,
            "inflow_cusecs": $INFLOW,
            "outflow_cusecs": $OUTFLOW,
            "water_level_change_ft": $CHANGE,
            "trend": "$TREND",
            "source": "https://www.tnagriculture.in/ARS/home/reservoir",
            "last_updated": "$(date -u)"
          }
          EOF

      - name: Commit & push
        run: |
          git config user.name "asma1611"
          git config user.email "asmaalavudeen2646@gmail.com"
          git add daily.json
          git commit -m "Real Mettur Dam daily update" || echo "No changes"
          git push
