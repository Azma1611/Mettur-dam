name: Mettur Dam Daily Update

on:
  schedule:
    - cron: '0 6 * * *'  # Runs every day at 6 AM UTC
  workflow_dispatch:      # Allows manual run

jobs:
  update-dam-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch TN reservoir data
        run: |
          # Download reservoir page
          HTML=$(curl -s https://tnagriculture.in/ARS/home/reservoir)

          # Extract the line with Mettur Dam
          LINE=$(echo "$HTML" | grep -oP 'METTUR.*?\\n')

          # Extract columns from line (adjust if page format changes)
          LEVEL=$(echo "$LINE" | awk '{print $4}')
          STORAGE=$(echo "$LINE" | awk '{print $5}')
          INFLOW=$(echo "$LINE" | awk '{print $6}')
          OUTFLOW=$(echo "$LINE" | awk '{print $7}')

          # Current date
          DATE=$(date '+%Y-%m-%d')

          # Read old daily.json if exists
          if [ -f daily.json ]; then
            OLD_LEVEL=$(jq '.water_level_ft' daily.json)
            OLD_INFLOW=$(jq '.inflow_cusecs' daily.json)
            OLD_OUTFLOW=$(jq '.outflow_cusecs' daily.json)
          else
            OLD_LEVEL=0
            OLD_INFLOW=0
            OLD_OUTFLOW=0
          fi

          # Calculate changes
          CHANGE_LEVEL=$(awk "BEGIN {printf \"%.2f\", $LEVEL - $OLD_LEVEL}")
          CHANGE_INFLOW=$(awk "BEGIN {print $INFLOW - $OLD_INFLOW}")
          CHANGE_OUTFLOW=$(awk "BEGIN {print $OUTFLOW - $OLD_OUTFLOW}")

          # Create new JSON
          cat <<EOF > daily.json
{
  "dam_name": "Mettur Dam (Stanley Reservoir)",
  "date": "$DATE",
  "water_level_ft": $LEVEL,
  "storage_mcft": $STORAGE,
  "inflow_cusecs": $INFLOW,
  "outflow_cusecs": $OUTFLOW,
  "water_level_change_ft": $CHANGE_LEVEL,
  "inflow_change_cusecs": $CHANGE_INFLOW,
  "outflow_change_cusecs": $CHANGE_OUTFLOW,
  "source": "https://tnagriculture.in/ARS/home/reservoir"
}
EOF

      - name: Commit and push changes
        run: |
          git config user.name "asma1611"
          git config user.email "asmaalavudeen2646@gmail.com"
          git add daily.json
          git commit -m "Daily update: $DATE" || echo "No changes to commit"
          git push

